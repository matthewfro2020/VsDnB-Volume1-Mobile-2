name: Mobile-Ios

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  Build-iOS:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine Version
        id: ver
        run: |
          if git describe --tags --exact-match >/dev/null 2>&1; then
            echo "version=$(git describe --tags --exact-match)" >> $GITHUB_OUTPUT
          else
            echo "version=dev-$(date +'%Y%m%d-%H%M')" >> $GITHUB_OUTPUT
          fi

      - uses: krdlab/setup-haxe@master
        with:
          haxe-version: 4.3.6

      - name: Install Haxelib Dependencies
        run: |
          haxelib install hxcpp
          haxelib install thx.core
          haxelib install thx.semver
          haxelib install lime
          haxelib install openfl
          haxelib install flixel

      # ────────────── BUILD TO GENERATE C++ (this always fails before Xcode) ──────────────
      - name: Generate iOS C++
        run: |
          # Force HXCPP C++ generation even if it fails
          haxelib run lime build ios -nosign -DofficialBuild -DMOBILE_BUILD -D HXCPP_CPP11 || true

      # ────────────── AUTO-PATCH thx.Nil ON THE GENERATED FILES ──────────────
      - name: Patch thx.Nil automatically
        run: |
          echo "=== Running UNIVERSAL thx.Nil PATCHER ==="
          python3 << 'EOF'
import os, re

ROOTS = [
    "./export/ios/obj",
    "./bin/ios/VsDave/haxe/build",
    "./bin/ios/VsDave/haxe/build/Release-iphoneos-64"
]

PATCHES = {
    r"\bNil\b": "ThxNil",
    r"thx::Nil": "thx::ThxNil",
}

patched = 0
for root in ROOTS:
    if not os.path.exists(root):
        continue
    for subdir, dirs, files in os.walk(root):
        for f in files:
            if f.endswith((".h", ".hpp", ".cpp", ".mm")):
                path = os.path.join(subdir, f)
                txt = open(path, "r").read()
                new = txt
                for a, b in PATCHES.items():
                    new = re.sub(a, b, new)
                if new != txt:
                    open(path, "w").write(new)
                    patched += 1

print(f"Patched {patched} file(s).")
EOF
          echo "=== Patch Completed ==="

      # ────────────── RUN FULL BUILD NOW THAT THE PATCH IS DONE ──────────────
      - name: Build iOS (Final)
        run: |
          haxelib run lime build ios -nosign -DofficialBuild -DMOBILE_BUILD -D HXCPP_CPP11
